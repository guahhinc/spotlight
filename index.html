<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spotlight Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #111; color: white; font-family: 'Montserrat', sans-serif; overflow: hidden; }
        #toolbar { position: absolute; left:0; top:0; bottom:0; width: 260px; background: #1a1a1a; padding: 20px; border-right: 2px solid #FFE600; display:flex; flex-direction:column; gap:15px; }
        h2 { color: #FFE600; margin:0; }
        input { padding: 10px; background: #333; border: 1px solid #555; color: white; width: 90%; }
        button { padding: 12px; background: #FFE600; border: none; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        .swatch { height: 35px; width: 35px; border-radius: 4px; display:inline-block; margin:2px; cursor:pointer; border:2px solid transparent; }
        .swatch.active { border-color:white; }
        .user-tag { font-size: 0.8rem; color: #888; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="toolbar">
    <button style="background:transparent; border:1px solid #555; color:#888;" onclick="location.href='index.html'">EXIT</button>
    <h2>STUDIO</h2>
    <div class="user-tag" id="creator-display">Detecting User...</div>
    
    <input id="mName" placeholder="Map Name">
    <label>Sky Color</label>
    <input type="color" id="mSky" value="#87CEEB">
    <div id="pal"></div>
    <div style="margin-top:auto">
        <p style="font-size:0.8rem; color:#666;">Left Click: Place<br>Right Click: Rotate Cam<br>Shift + Left Click: Delete</p>
        <button onclick="publish()">PUBLISH MAP</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
    const user = localStorage.getItem("sp_user");
    if(!user) { alert("Login required."); window.location.href="index.html"; }
    document.getElementById("creator-display").innerText = "Creator: " + user;

    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbykgoDaT5pKCxI7FfQE59lcPYt6MAgLNioWZrlot2mxG2uZsJ8BBtVUzjW6BSrK4ueq/exec";
    
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0x222);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(10,10,10);
    const renderer = new THREE.WebGLRenderer(); renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    
    // Controls: LEFT CLICK DOES NOTHING TO CAM, RIGHT CLICK ROTATES
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.mouseButtons = { LEFT: null, MIDDLE: THREE.MOUSE.DOLLY, RIGHT: THREE.MOUSE.ROTATE }; 
    
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dl = new THREE.DirectionalLight(0xffffff, 0.8); dl.position.set(5,10,5); scene.add(dl);
    scene.add(new THREE.GridHelper(50,50));
    const plane = new THREE.Mesh(new THREE.PlaneGeometry(50,50), new THREE.MeshBasicMaterial({visible:false}));
    plane.rotation.x = -Math.PI/2; scene.add(plane);

    let blocks = {};
    let col = 0xff0000;
    const colors = [0xffffff, 0x555555, 0x111111, 0x8B4513, 0xff0000, 0x00ff00, 0x0000ff, 0xffff00];
    
    const pal = document.getElementById("pal");
    colors.forEach(c => {
        const d = document.createElement("div"); d.className = "swatch"; d.style.background = "#"+c.toString(16).padStart(6,'0');
        d.onclick = () => { col = c; document.querySelectorAll(".swatch").forEach(s=>s.classList.remove("active")); d.classList.add("active"); };
        pal.appendChild(d);
    });

    const ray = new THREE.Raycaster(); const mouse = new THREE.Vector2();
    const ghost = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshBasicMaterial({color:0x00ffff, opacity:0.5, transparent:true}));
    scene.add(ghost);

    document.addEventListener('mousemove', e => {
        mouse.x = (e.clientX/window.innerWidth)*2-1; mouse.y = -(e.clientY/window.innerHeight)*2+1;
        ray.setFromCamera(mouse, camera);
        const intersects = ray.intersectObjects([plane, ...Object.values(scene.children).filter(c=>c.geometry?.type==='BoxGeometry' && c!==ghost)]);
        if(intersects.length > 0) {
            const i = intersects[0];
            const p = i.point.clone().add(i.face.normal.clone().multiplyScalar(0.5)).floor().addScalar(0.5);
            ghost.position.copy(p); ghost.visible = true;
        } else { ghost.visible = false; }
    });

    document.addEventListener('mousedown', e => {
        if(e.button !== 0 || e.target.closest("#toolbar")) return; // Only Left Click
        ray.setFromCamera(mouse, camera);
        const intersects = ray.intersectObjects([plane, ...Object.values(scene.children).filter(c=>c.geometry?.type==='BoxGeometry' && c!==ghost)]);
        if(intersects.length > 0) {
            const i = intersects[0];
            if(e.shiftKey) {
                if(i.object!==plane) { scene.remove(i.object); delete blocks[`${i.object.position.x},${i.object.position.y},${i.object.position.z}`]; }
            } else {
                const p = i.point.clone().add(i.face.normal.clone().multiplyScalar(0.5)).floor().addScalar(0.5);
                const k = `${p.x},${p.y},${p.z}`;
                if(!blocks[k]) {
                    const m = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshLambertMaterial({color:col}));
                    m.position.copy(p); scene.add(m); blocks[k] = col;
                }
            }
        }
    });

    function publish() {
        const name = document.getElementById("mName").value;
        if(!name) return alert("Enter Name");
        if(Object.keys(blocks).length===0) return alert("Empty Map");
        const bStr = Object.entries(blocks).map(([k,v]) => `${k},${v}`).join("|");
        fetch(WEB_APP_URL, {
            method: "POST", mode: "no-cors",
            body: JSON.stringify({ action: "saveMap", name: name, creator: user, skyColor: document.getElementById("mSky").value, mapData: bStr })
        }).then(() => { alert("Published!"); window.location.href = "index.html"; });
    }

    function ani(){ requestAnimationFrame(ani); controls.update(); renderer.render(scene, camera); }
    ani();
</script>
</body>
</html>
